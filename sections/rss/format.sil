% RSS section class: load data/rss.json and render a short list of items
\define[command=rsssection]{
  \sectionbox{
    \sectiontitle{RSS Highlights}
    \lua{
      local path = "data/rss.json"
      local load = SILE.scratch.load_json_file
      if not load then
        SILE.typesetter:typeset("JSON helper not available; ensure \\loaddata ran.")
        return
      end
      local data, err = load(path)
      if not data then
        SILE.typesetter:typeset("Failed to load " .. path .. " (" .. tostring(err) .. ")")
        return
      end

      local items = type(data.items) == "table" and data.items or {}
      if type(items) ~= "table" then
        SILE.typesetter:typeset("Invalid RSS JSON schema (no items).")
        return
      end

      -- Render items in supplied order, grouping by source without reordering
      local current_source = nil
      for idx = 1, #items do
        local it = items[idx] or {}
        local source = tostring(it.source or "Blog")
        if source ~= current_source then
          if current_source ~= nil then
            SILE.call("rssGroupSeparator")
          end
          SILE.call("rssGroupTitle", {}, function()
            SILE.typesetter:typeset(source)
          end)
          current_source = source
        end

        local atitle = tostring(it.title or "(untitled)")
        SILE.call("rssItemTitle", {}, function()
          SILE.typesetter:typeset(atitle)
        end)

        local subs = it.subtitles or {}
        if type(subs) ~= "table" then subs = {} end
        for k = 1, #subs do
          local sub = tostring(subs[k] or "")
          if sub ~= "" then
            SILE.call("rssSubtitle", {}, function()
              SILE.typesetter:typeset(sub)
            end)
          end
        end
        SILE.call("rssItemSeparator")
      end
    }
  }
}
